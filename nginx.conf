server {
  listen 3000;
  server_name localhost;

  # Use Docker DNS for dynamic service name resolution
  resolver 127.0.0.11 ipv6=off;
  # Force dynamic resolution each request by using a variable host
  set $backend_host backend;

  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  # Proxy API requests to backend service
  location /api/ {
    # Forward original URI intact to backend (context-path /api is preserved)
    proxy_pass http://$backend_host:8080;
    proxy_http_version 1.1;
    # Normal HTTP requests should keep-alive (Upgrade used for WS only)
    proxy_set_header Connection "keep-alive";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_redirect off;
    proxy_connect_timeout 5s;
    proxy_read_timeout 60s;
    proxy_next_upstream error timeout http_502 http_503;
    proxy_next_upstream_tries 2;
  }

  # WebSocket proxy (if frontend connects directly to /ws)
  location /ws/ {
    # Backend dùng context-path /api, endpoint WS là /api/ws
    proxy_pass http://$backend_host:8080/api/ws/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
  }

  # Serve static assets with cache headers
  location ~* \.(?:css|js|jpg|jpeg|gif|png|svg|ico|woff2?)$ {
    expires 7d;
    add_header Cache-Control "public";
  }
}
